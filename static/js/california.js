// Generated by CoffeeScript 1.6.3
(function() {
  var CountyMapControls, id, text, value,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  id = function(d) {
    return d;
  };

  value = function(d) {
    return d.value;
  };

  text = function(d) {
    return d.text;
  };

  CountyMapControls = (function() {
    function CountyMapControls(map, meta) {
      var age_data, ages, changeEvent, controls, g, races, selectedAge, selectedRace, selectedYear, selector, years, zoom, _i, _len, _ref;
      controls = d3.select('body').append('div');
      years = controls.append('select');
      years.selectAll('option').data(meta.year).enter().append('option').attr('value', id).text(id);
      ages = controls.append('select');
      age_data = [
        {
          value: "all",
          text: "all Age groups"
        }
      ].concat((function() {
        var _i, _len, _ref, _results;
        _ref = meta.age_group;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          g = _ref[_i];
          _results.push({
            value: g,
            text: "" + (g.replace("..", " to ")) + " year olds"
          });
        }
        return _results;
      })());
      ages.selectAll('option').data(age_data).enter().append('option').attr('value', value).text(text);
      races = controls.append('select');
      races.selectAll('option').data(["all"].concat(meta.race)).enter().append('option').attr('value', id).text(id);
      zoom = controls.append('select');
      zoom.selectAll('option').data([
        {
          text: "Bay Area",
          value: 14000
        }, {
          text: "California",
          value: 4500
        }
      ]).enter().append('option').attr('value', value).text(text);
      zoom.on('change', function() {
        return map.zoom(zoom.node().value);
      });
      selectedYear = function() {
        return years.node().value;
      };
      selectedRace = function() {
        return races.node().value;
      };
      selectedAge = function() {
        return ages.node().value;
      };
      changeEvent = function() {
        return map.loadPopulationData(selectedYear(), selectedRace(), selectedAge());
      };
      _ref = [years, races, ages];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        selector = _ref[_i];
        selector.on('change', changeEvent);
      }
      map.onLoad = changeEvent;
    }

    return CountyMapControls;

  })();

  window.CountyMap = (function() {
    CountyMap.prototype.height = 800;

    CountyMap.prototype.width = 1100;

    CountyMap.prototype.onLoad = function() {};

    function CountyMap(meta, options) {
      var modes, table, tbody, tr,
        _this = this;
      if (options == null) {
        options = {
          mode: "percent_population"
        };
      }
      this.loadPopulationData = __bind(this.loadPopulationData, this);
      this._load_by_density = __bind(this._load_by_density, this);
      this._load_by_income = __bind(this._load_by_income, this);
      this.appendHoverLayer = __bind(this.appendHoverLayer, this);
      this.appendCounties = __bind(this.appendCounties, this);
      this.zoom = __bind(this.zoom, this);
      this.svg = d3.select('#main').append('svg').attr('width', this.width).attr('height', this.height);
      this.svg.append('rect').attr('width', this.width).attr('height', this.height).style('fill', '#f9f9f9').style('stroke', 'gray');
      this.projection = d3.geo.albers().scale(14000).rotate([122.8600, 0, 0]).center([0, 37.3500]).parallels([36, 35]).translate([this.width / 4, this.height / 2]);
      this.path = d3.geo.path().projection(this.projection);
      this._meta = meta;
      modes = [
        {
          mode: "percent_population",
          name: "Demographic Cohorts",
          description: "For each selectable age category and ethnic group, shows the           percentage of that groups representation in each county. Projections made by          the California Department of Finance Demographic Research Unit."
        }, {
          mode: "percent_change",
          name: "Change in Demographic Cohorts",
          description: "For each selectable age category and ethnic group, shows the change in percentage          for each county over a 50-year period."
        }, {
          mode: "income",
          name: "Median Household Income",
          description: "Median household income by county.           Data from the American Community Survey (US Census Dept) 2012 5-year Estimates."
        }, {
          mode: "density",
          name: "Population Density",
          description: "Raw population estimates divided by the area of the county.          Data from the American Community Survey (US Census Dept) 2012 5-year Estimates."
        }
      ];
      table = d3.select('#main').append('table').attr('id', 'mode_selection');
      table.append('thead');
      tbody = table.append('tbody');
      this.modeSelection = tbody.append('tr');
      this.modeSelection.selectAll('td.button').data(modes).enter().append('td').attr('class', 'button').text(function(d) {
        return d.name;
      }).on('click', function(d) {
        return _this.changeMode(d.mode);
      });
      tr = tbody.append('tr');
      tr.selectAll('td.description').data(modes).enter().append('td').attr('class', 'description').text(function(d) {
        return d.description;
      });
      d3.json('/static/data/cali.json', function(error, counties) {
        _this.appendCounties(counties);
        _this.appendOutline(counties);
        _this.appendHoverLayer(counties);
        _this.appendZoomControls();
        return _this.changeMode(options.mode);
      });
    }

    CountyMap.prototype.setModeSelectorClass = function() {
      var _this = this;
      return this.modeSelection.selectAll('td.button').classed('active', function(d) {
        return d.mode === _this._mode;
      });
    };

    CountyMap.prototype.mode = function(d) {
      if (d) {
        this._mode = d;
        return this;
      }
      return this._mode;
    };

    CountyMap.prototype.changeMode = function(mode) {
      this._mode = mode;
      this.colors = this._colors[this._mode];
      if (this.legend) {
        this.legend.remove();
      }
      if (this.liveLegend) {
        this.liveLegend.remove();
      }
      this["appendLegend_" + this._mode]();
      this["appendLiveLegend_" + this._mode]();
      this.onLoad();
      return this.setModeSelectorClass();
    };

    CountyMap.prototype._colors = {
      percent_change: d3.scale.linear().domain([-1, -0.25, 0, 0.25, 1]).range(['#e74c3c', '#e74c3c', 'white', '#2ecc71', '#2ecc71']),
      percent_population: d3.scale.linear().domain([0, 0.25, 1]).range(['#fff', '#3498DB', '#E74C3C']),
      income: d3.scale.linear().domain([0, 30000, 50000, 100000]).range(['white', 'white', '#f1c40f', '#e74c3c']),
      density: d3.scale.linear().domain([0, 2000, 5000, 20000]).range(['white', '#3498db', '#1ABC9C', '#1ABC9C'])
    };

    CountyMap.prototype.animateOnce = function() {
      var animate, intId, years,
        _this = this;
      years = this._meta.year.concat([]);
      intId = null;
      animate = function() {
        var year;
        if (years.length === 0) {
          clearInterval(intId);
          return;
        }
        year = years.shift();
        _this.years.select("option[value=\"" + year + "\"]").attr('selected', 'selected');
        return _this.changeEvent();
      };
      return intId = setInterval(animate, 500);
    };

    CountyMap.prototype.animate = function() {
      var animate, index, years, ylength,
        _this = this;
      years = this._meta.year;
      ylength = years.length;
      index = 0;
      animate = function() {
        var year;
        year = years[index % years.length];
        index++;
        _this.years.select("option[value=\"" + year + "\"]").attr('selected', 'selected');
        return _this.changeEvent();
      };
      return this.repId = setInterval(animate, 250);
    };

    CountyMap.prototype.stopAnimation = function() {
      clearInterval(this.repId);
      return this.repId = null;
    };

    CountyMap.prototype.appendLiveLegend_income = function() {
      return this.loadPopulationData();
    };

    CountyMap.prototype.appendLiveLegend_percent_population = function() {
      var age_data, ages, g, large_text, race_data, races, selectedAge, selectedRace, selectedYear, selector, small_text, years, _i, _len, _ref;
      this._legendWrapper = this.svg.append('foreignObject').attr('x', 40).attr('y', this.height - 150).attr('width', 360).attr('height', 200);
      this.liveLegend = this._legendWrapper.append('xhtml:div');
      large_text = this.liveLegend.append('p').attr('class', 'large');
      small_text = this.liveLegend.append('p').attr('class', 'small');
      small_text.append('span').text('AS A PERCENTAGE OF THE TOTAL,');
      years = small_text.append('select').attr('class', 'small');
      years.selectAll('option').data(this._meta.year).enter().append('option').attr('value', id).text(id);
      this.years = years;
      small_text.append('span').text('ESTIMATE');
      races = large_text.append('select').attr('class', 'large');
      race_data = [
        {
          value: "all",
          text: "All Ethnicities"
        }
      ].concat((function() {
        var _i, _len, _ref, _results;
        _ref = this._meta.race;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          g = _ref[_i];
          _results.push({
            value: g,
            text: g
          });
        }
        return _results;
      }).call(this));
      races.selectAll('option').data(race_data).enter().append('option').attr('value', value).text(text);
      large_text.append('span').text(",");
      ages = large_text.append('select').attr('class', 'large');
      age_data = [
        {
          value: "all",
          text: "All Age Groups"
        }
      ].concat((function() {
        var _i, _len, _ref, _results;
        _ref = this._meta.age_group;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          g = _ref[_i];
          _results.push({
            value: g,
            text: "" + (g.replace("..", " to ")) + " year olds"
          });
        }
        return _results;
      }).call(this));
      ages.selectAll('option').data(age_data).enter().append('option').attr('value', value).text(text);
      selectedYear = function() {
        return years.node().value;
      };
      selectedRace = function() {
        return races.node().value;
      };
      selectedAge = function() {
        return ages.node().value;
      };
      this.changeEvent = function() {
        return map.loadPopulationData(selectedYear(), selectedRace(), selectedAge());
      };
      _ref = [years, races, ages];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        selector = _ref[_i];
        selector.on('change', this.changeEvent);
      }
      ages.select('option[value="18..44"]').attr('selected', 'selected');
      return map.onLoad = this.changeEvent;
    };

    CountyMap.prototype.appendLiveLegend_percent_change = function() {
      var age_data, ages, g, large_text, race_data, races, selectedAge, selectedRace, selector, small_text, _i, _len, _ref;
      this._legendWrapper = this.svg.append('foreignObject').attr('x', 40).attr('y', this.height - 150).attr('width', 360).attr('height', 200);
      this.liveLegend = this._legendWrapper.append('xhtml:div');
      large_text = this.liveLegend.append('p').attr('class', 'large');
      small_text = this.liveLegend.append('p').attr('class', 'small');
      small_text.append('span').text('2010-2060 CHANGE IN PERCENTAGE OF THE TOTAL');
      races = large_text.append('select').attr('class', 'large');
      race_data = [
        {
          value: "all",
          text: "All Ethnicities"
        }
      ].concat((function() {
        var _i, _len, _ref, _results;
        _ref = this._meta.race;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          g = _ref[_i];
          _results.push({
            value: g,
            text: g
          });
        }
        return _results;
      }).call(this));
      races.selectAll('option').data(race_data).enter().append('option').attr('value', value).text(text);
      large_text.append('span').text(",");
      ages = large_text.append('select').attr('class', 'large');
      age_data = [
        {
          value: "all",
          text: "All Age Groups"
        }
      ].concat((function() {
        var _i, _len, _ref, _results;
        _ref = this._meta.age_group;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          g = _ref[_i];
          _results.push({
            value: g,
            text: "" + (g.replace("..", " to ")) + " year olds"
          });
        }
        return _results;
      }).call(this));
      ages.selectAll('option').data(age_data).enter().append('option').attr('value', value).text(text);
      selectedRace = function() {
        return races.node().value;
      };
      selectedAge = function() {
        return ages.node().value;
      };
      this.changeEvent = function() {
        return map.loadPopulationData(2010, selectedRace(), selectedAge());
      };
      _ref = [races, ages];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        selector = _ref[_i];
        selector.on('change', this.changeEvent);
      }
      ages.select('option[value="18..44"]').attr('selected', 'selected');
      return map.onLoad = this.changeEvent;
    };

    CountyMap.prototype.appendZoomControls = function() {
      var zoom, zoomControl;
      this._zoomControlWrapper = this.svg.append('foreignObject').attr('x', 40).attr('y', this.height - 40).attr('width', 330).attr('height', 200);
      zoomControl = this._zoomControlWrapper.append('xhtml:div').style('font-size', '10pt');
      zoomControl.append('span').text('ZOOM TO:');
      zoom = zoomControl.append('select').attr('class', 'small');
      zoom.selectAll('option').data([
        {
          text: "Bay Area",
          value: 14000
        }, {
          text: "California",
          value: 4500
        }
      ]).enter().append('option').attr('value', value).text(text);
      return zoom.on('change', function() {
        return map.zoom(zoom.node().value);
      });
    };

    CountyMap.prototype.appendLegend_percent_change = function() {
      var legendData, legendX, n, percent;
      this.legend = this.svg.append('g').attr('id', 'legend').attr('transform', "translate(30, " + (this.height - 100) + ")");
      legendX = function(d) {
        return 600 * d + 160;
      };
      legendData = (function() {
        var _i, _results;
        _results = [];
        for (n = _i = -0.25; 0.05 > 0 ? _i <= 0.25 : _i >= 0.25; n = _i += 0.05) {
          _results.push(n);
        }
        return _results;
      })();
      this.legend.selectAll('rect').data(legendData).enter().append('rect').attr('x', legendX).attr('y', 10).attr('width', 30).attr('height', 30).style('stroke', 'white').style('fill', this.colors);
      percent = d3.format("%");
      return this.legend.selectAll('text.percentage').data(legendData).enter().append('text').attr('transform', function(d) {
        return "translate(" + (legendX(d) + 15) + ", 50)";
      }).text(percent).style('text-anchor', 'middle').style('font-size', 10).style('font-weight', 'bold');
    };

    CountyMap.prototype.appendLegend_income = function() {
      var format, large_text, legendData, legendX, n, small_text, source;
      this.legend = this.svg.append('g').attr('id', 'legend').attr('transform', "translate(30, " + (this.height - 100) + ")");
      legendX = function(d) {
        return 30 * d / 10000 - 90;
      };
      legendData = (function() {
        var _i, _results;
        _results = [];
        for (n = _i = 30000; _i <= 100000; n = _i += 10000) {
          _results.push(n);
        }
        return _results;
      })();
      this.legend.selectAll('rect').data(legendData).enter().append('rect').attr('x', legendX).attr('y', 10).attr('width', 30).attr('height', 30).style('stroke', 'white').style('fill', this.colors);
      format = d3.format("0,000");
      this.legend.selectAll('text.income').data(legendData).enter().append('text').attr('transform', function(d) {
        return "translate(" + (legendX(d) + 15) + ", 50)";
      }).text(function(d) {
        return "" + (d / 1000) + "K";
      }).style('text-anchor', 'middle').style('font-size', 10).style('font-weight', 'bold');
      large_text = this.legend.append('text').text("Median Household Income").attr('class', 'large').attr('transform', "translate(0, -35)");
      small_text = this.legend.append('text').text('IN US DOLLARS').attr('class', 'small').attr('transform', "translate(0, -20)");
      return source = this.legend.append('text').text('SOURCE: American Community Survey, 2012 5-Year Estimates').style('font-size', '8pt');
    };

    CountyMap.prototype.appendLegend_percent_population = function() {
      var legendData, legendX, n, percent;
      this.legend = this.svg.append('g').attr('id', 'legend').attr('transform', "translate(30, " + (this.height - 100) + ")");
      legendX = function(d) {
        return 300 * d + 10;
      };
      legendData = (function() {
        var _i, _results;
        _results = [];
        for (n = _i = 0; _i <= 1; n = _i += 0.1) {
          _results.push(n);
        }
        return _results;
      })();
      this.legend.selectAll('rect').data(legendData).enter().append('rect').attr('x', legendX).attr('y', 10).attr('width', 30).attr('height', 30).style('stroke', 'white').style('fill', this.colors);
      percent = d3.format("%");
      return this.legend.selectAll('text.percentage').data(legendData).enter().append('text').attr('transform', function(d) {
        return "translate(" + (legendX(d) + 15) + ", 50)";
      }).text(percent).style('text-anchor', 'middle').style('font-size', 10).style('font-weight', 'bold');
    };

    CountyMap.prototype.appendLegend_density = function() {
      var format, large_text, legendData, legendX, n, small_text, source;
      this.legend = this.svg.append('g').attr('id', 'legend').attr('transform', "translate(30, " + (this.height - 100) + ")");
      legendX = function(d) {
        return 30 * d / 500;
      };
      legendData = (function() {
        var _i, _results;
        _results = [];
        for (n = _i = 0; _i <= 5000; n = _i += 500) {
          _results.push(n);
        }
        return _results;
      })();
      this.legend.selectAll('rect').data(legendData).enter().append('rect').attr('x', legendX).attr('y', 10).attr('width', 30).attr('height', 30).style('stroke', 'white').style('fill', this.colors);
      format = function(d) {
        return "" + (d / 1000) + "K";
      };
      this.legend.selectAll('text.density').data(legendData).enter().append('text').attr('transform', function(d) {
        return "translate(" + (legendX(d) + 15) + ", 50)";
      }).text(format).style('text-anchor', 'middle').style('font-size', 10).style('font-weight', 'bold');
      large_text = this.legend.append('text').text("Population Density").attr('class', 'large').attr('transform', "translate(0, -35)");
      small_text = this.legend.append('text').text('PER SQUARE MILE').attr('class', 'small').attr('transform', "translate(0, -20)");
      return source = this.legend.append('text').text('SOURCE: American Community Survey, 2012 5-Year Estimates').style('font-size', '8pt');
    };

    CountyMap.prototype.appendLiveLegend_density = function() {
      return this.loadPopulationData();
    };

    CountyMap.prototype.appendControls = function(meta) {
      return new CountyMapControls(this, meta);
    };

    CountyMap.prototype.appendOutline = function(counties) {
      this.outline = this.svg.append('path').datum(topojson.mesh(counties, counties.objects.california_counties, function(a, b) {
        return a === b && a.id === b.id;
      })).attr('class', 'outline').attr('d', this.path).style('stroke', 'gray').style('stroke-width', '1pt').style('fill', 'none');
      return this.bay_area = this.svg.append('path').datum(topojson.merge(counties, counties.objects.california_counties.geometries.filter(function(d) {
        return d.properties.bay_area;
      }))).attr('class', 'outline').attr('d', this.path).style('stroke', 'black').style('stroke-width', '2pt').style('stroke-dasharray', '3, 4').style('fill', 'none');
    };

    CountyMap.prototype.zoom = function(scale) {
      var _this = this;
      if (this.repId) {
        this.stopAnimation();
      }
      this.projection.scale(scale);
      this.path.projection(this.projection);
      this.counties.selectAll('path').transition().duration(1000).attr('d', this.path);
      this.hoverLayer.selectAll('path').attr('d', this.path);
      this.hoverLayer.selectAll('text.name').attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1];
      });
      this.hoverLayer.selectAll('text.value').attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1] + 15;
      });
      this.outline.transition().duration(1000).attr('d', this.path);
      return this.bay_area.transition().duration(1000).attr('d', this.path);
    };

    CountyMap.prototype.appendCounties = function(counties) {
      this.counties = this.svg.selectAll('.county').data(topojson.feature(counties, counties.objects.california_counties).features).enter().append('g').attr('class', 'county');
      return this.counties.append('path').attr('class', 'fill').datum(function(d) {
        return d;
      }).attr('d', this.path).style('fill', 'white');
    };

    CountyMap.prototype.appendHoverLayer = function(counties) {
      var _this = this;
      this.hoverLayer = this.svg.selectAll('.county_hover').data(topojson.feature(counties, counties.objects.california_counties).features).enter().append('g').attr('class', 'tooltip county_hover').style('opacity', 0);
      this.hoverLayer.append('path').datum(function(d) {
        return d;
      }).attr('d', this.path).style('stroke', 'black').style('stroke-width', 2).style('fill', 'white').style('fill-opacity', 0);
      this.hoverLayer.append('text').text(function(d) {
        return d.properties.name;
      }).attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1];
      }).attr('text-anchor', 'middle').attr('class', 'name').style('font-weight', 'bold').style('font-size', '8pt').style('stroke', 'white').style('stroke-width', '2pt');
      this.hoverLayer.append('text').text(function(d) {
        return d.properties.name;
      }).attr('class', 'name').attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1];
      }).attr('text-anchor', 'middle').style('font-weight', 'bold').style('font-size', '8pt');
      this.hoverLayer.append('text').attr('class', 'value').attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1] + 15;
      }).attr('text-anchor', 'middle').style('font-size', '8pt').style('stroke', 'white').style('stroke-width', '2pt').style('font-weight', 'bold');
      this.hoverLayer.append('text').attr('class', 'value').attr('x', function(d) {
        return _this.path.centroid(d)[0];
      }).attr('y', function(d) {
        return _this.path.centroid(d)[1] + 15;
      }).attr('text-anchor', 'middle').style('font-size', '8pt').style('font-weight', 'bold');
      return this.hoverLayer.on('mouseover', function(d) {
        return d3.select(this).style('opacity', 1);
      }).on('mouseout', function() {
        return d3.select(this).style('opacity', 0);
      });
    };

    CountyMap.prototype.updateWindow = function() {
      var x, y;
      x = window.innerWidth;
      return y = window.innerHeight;
    };

    CountyMap.prototype._load_by_percent_population = function(year, race, age) {
      var _this = this;
      return this._requestData(year, race, age, function(data) {
        return _this._requestData(year, "all", "all", function(totals) {
          var colorWrapper, percentageOfTotal, pop, row, _i, _j, _len, _len1;
          pop = {};
          for (_i = 0, _len = data.length; _i < _len; _i++) {
            row = data[_i];
            pop[row.county] = row;
          }
          for (_j = 0, _len1 = totals.length; _j < _len1; _j++) {
            row = totals[_j];
            pop[row.county].total = row.estimate;
          }
          colorWrapper = function(value) {
            return _this.colors(percentageOfTotal(value));
          };
          percentageOfTotal = function(d) {
            var p;
            p = pop[d.properties.name];
            return p.estimate / p.total;
          };
          _this.counties.selectAll('path.fill').transition().style('fill', function(d) {
            return _this.colors(percentageOfTotal(d));
          });
          return _this.hoverLayer.selectAll('text.value').text(function(d) {
            return "" + (d3.round(100 * percentageOfTotal(d), 1)) + "%";
          });
        });
      });
    };

    CountyMap.prototype._load_by_percent_change = function(year, race, age) {
      var _this = this;
      return this._requestData(2010, race, age, function(data2010) {
        return _this._requestData(2060, race, age, function(data2060) {
          return _this._requestData(2010, 'all', 'all', function(total2010) {
            return _this._requestData(2060, 'all', 'all', function(total2060) {
              var colorWrapper, percentageChange, pop, row, _i, _j, _k, _l, _len, _len1, _len2, _len3;
              pop = {};
              for (_i = 0, _len = data2010.length; _i < _len; _i++) {
                row = data2010[_i];
                pop[row.county] = row;
              }
              for (_j = 0, _len1 = total2010.length; _j < _len1; _j++) {
                row = total2010[_j];
                pop[row.county].total2010 = row.estimate;
              }
              for (_k = 0, _len2 = data2060.length; _k < _len2; _k++) {
                row = data2060[_k];
                pop[row.county].estimate2060 = row.estimate;
              }
              for (_l = 0, _len3 = total2060.length; _l < _len3; _l++) {
                row = total2060[_l];
                pop[row.county].total2060 = row.estimate;
              }
              colorWrapper = function(value) {
                return _this.colors(percentageChange(value));
              };
              percentageChange = function(d) {
                var p;
                p = pop[d.properties.name];
                return (p.estimate2060 / p.total2060) - (p.estimate / p.total2010);
              };
              _this.counties.selectAll('path.fill').transition().style('fill', function(d) {
                return _this.colors(percentageChange(d));
              });
              return _this.hoverLayer.selectAll('text.value').text(function(d) {
                return "" + (d3.round(100 * percentageChange(d), 1)) + "%";
              });
            });
          });
        });
      });
    };

    CountyMap.prototype._load_by_income = function(year, race, age) {
      var _this = this;
      return d3.csv('income.csv', function(data) {
        var format, medianIncome, pop, row, _i, _len;
        pop = {};
        for (_i = 0, _len = data.length; _i < _len; _i++) {
          row = data[_i];
          pop[row.county] = row;
        }
        medianIncome = function(d) {
          return pop[d.properties.name].median_income;
        };
        format = d3.format("0,000");
        _this.counties.selectAll('path.fill').transition().style('fill', function(d) {
          return _this.colors(medianIncome(d));
        });
        return _this.hoverLayer.selectAll('text.value').text(function(d) {
          return "$" + (format(medianIncome(d)));
        });
      });
    };

    CountyMap.prototype._load_by_density = function(year, race, age) {
      var _this = this;
      return d3.csv('population.csv', function(data) {
        return d3.csv('data/square_miles.csv', function(area) {
          var areas, county, density, format, pop, row, _i, _j, _len, _len1;
          pop = {};
          areas = {};
          for (_i = 0, _len = data.length; _i < _len; _i++) {
            row = data[_i];
            pop[row.county] = row;
          }
          for (_j = 0, _len1 = area.length; _j < _len1; _j++) {
            row = area[_j];
            areas[row.county] = row.square_miles;
          }
          for (county in pop) {
            row = pop[county];
            row.density = Math.round(row.population / areas[county]);
          }
          density = function(d) {
            return pop[d.properties.name].density;
          };
          format = d3.format("0,000");
          _this.counties.selectAll('path.fill').transition().style('fill', function(d) {
            return _this.colors(density(d));
          });
          return _this.hoverLayer.selectAll('text.value').text(function(d) {
            return "" + (format(density(d))) + " / sq. mile";
          });
        });
      });
    };

    CountyMap.prototype.loadPopulationData = function(year, race, age) {
      age || (age = "all");
      return this["_load_by_" + this._mode](year, race, age);
    };

    CountyMap.prototype._requestData = function(year, race, age, callback) {
      var data,
        _this = this;
      this._cache || (this._cache = {});
      if ((data = this._cache[[year, race, age]])) {
        return callback(data);
      } else {
        return d3.json("/data.json?year=" + year + "&race=" + race + "&age_group=" + age + "&gender=all", function(data) {
          _this._cache[[year, race, age]] = data;
          return callback(data);
        });
      }
    };

    return CountyMap;

  })();

}).call(this);
